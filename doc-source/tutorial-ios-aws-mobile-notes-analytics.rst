.. _tutorial-ios-aws-mobile-notes-analytics:

##############################
Add Analytics to the Notes App
##############################

In the :ref:`previous section <tutorial-ios-aws-mobile-notes-setup>` of this tutorial , we installed Xcode, downloaded a sample note-taking app from GitHub, then compiled and ran
it on an iOS Simulator. This tutorial assumes you have completed the
those steps. In this section, we will extend the notes app to
include application analytics. Application analytics allow us to gather
demographic information about the application usage.

You should be able to complete this section in 10-15 minutes.

Create an AWS Mobile Hub project
--------------------------------

To start, set up the mobile backend resources in AWS:

1. Open the `AWS Mobile Hub console <https://console.aws.amazon.com/mobilehub/home/>`_.

   -  If you do not have an AWS account, `sign up for the AWS
      Free Tier <https://aws.amazon.com/free/>`_.

2. Choose :guilabel:`Create a new project`.

3. Type :userinput:`ios-notes-app` for the name of the |AMH| project.

4. Choose :guilabel:`Create project`.


Download the AWS configuration file
-----------------------------------

1.  In your |AMH| console project, choose the :guilabel:`Integrate` icon on the left.

2.  Choose :guilabel:`Download Configuration File` to get the :file:`awsconfiguration.json` file that connects your app to your backend.

Remember: Each time you change the |AMH| project for your app, download and use an updated :file:`awsconfiguration.json` to reflect those changes in your app.


Setup your app for AWS Mobile services
--------------------------------------

#. Install Cocoapods

   From a terminal window run:

   .. code-block:: bash

      sudo gem install cocoapods

   #. Create Podfile

      From a terminal window, navigate to the :file:`MyNotes` directory that contains the project's :file:`.xcodeproj` file and run:

      .. code-block:: bash

          pod init


   #. Open the :file`Podfile` you created and add AWS Mobile SDK analytics components to your build as follows.

      .. code-block:: bash

          platform :ios, '9.0'

          target :'MyNotes' do
            use_frameworks!

               pod 'AWSPinpoint', '~> 2.6.5'
               # other pods

         end

   #. Run:

      .. code-block:: bash

           pod install --repo-update

   That’s it. You have now installed and implemented Cocoa Pods. 

   .. list-table::
      :widths: 1 6

      * - **Note**

      * - Always open cocoapod projects with :file:`.xcworkspace`

           Once you start using Cocoapods, you no longer open the project in Xcode using the MyNotes.xcodeproj. Instead, always use the :file:`.xcworkspace` file generated by Cocoapods to launch the project in Xcode.


5. **FIX THIS???- - - we never closed Xcode** Open MyNotes app project in Xcode (using .xcworkspace)

6. Add Core AWS Mobile Imports

   Add the following two import statements to the :code:`AppDelegate.swift`, :code:`MasterViewController.swift`, and :code:`DetailsViewController.swift` classes.

   .. code-block:: bash

      import AWSCore
      import AWSPinpoint

7. Add the Backend Service Configuration to Your APp

From the location where you downloaded your |AMH| project configuration file:

   #. Drag :file:`awsconfiguration.json` into the folder containing the :file:`info.plist` file of your Xcode project.

   #. Choose :guilabel:`Copy items if needed` and :guilabel:`Create groups` in the options dialog.

8.  Put the following code in the AppDelegate.swift class.

    .. code-block:: swift

        import UIKit
        import AWSAuthCore

        @UIApplicationMain

        class AppDelegate: UIResponder, UIApplicationDelegate {


            var pinpoint: AWSPinpoint?


            func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplicationLaunchOptionsKey: Any]?) -> Bool {


        pinpoint = AWSPinpoint(configuration:
                    AWSPinpointConfiguration.defaultPinpointConfiguration(launchOptions: launchOptions))

            return true

            // . . .
        }

9.  Build and run MyNotes app to see usage metrics in Amazon Pinpoint.

On iOS, the AWS Pinpoint SDK begins collecting user demographics and session details straight away. To see visualizations of those default analytics coming from your app, open the Amazon Pinpoint console.



Monitor add and delete notes in Amazon Pinpoint
-----------------------------------------------

We can also monitor feature usage within our app. In this example, we
will monitor how often users add and delete notes. We will record a
custom event for each operation. The Delete Note operation occurs in the
:file:`NoteListActivity.java` class. Review the :code:`onSwiped` method at line
142, and add the following code:

.. code-block:: java
   :emphasize-lines: 6-13

    @Override
    public void onSwiped(RecyclerView.ViewHolder viewHolder, int direction) {
        final NoteViewHolder noteHolder = (NoteViewHolder) viewHolder;
        ((NotesAdapter) notesList.getAdapter()).remove(noteHolder);

        // Send Custom Event to Amazon Pinpoint
        final AnalyticsClient mgr = AWSProvider.getInstance()
                .getPinpointManager()
                .getAnalyticsClient();
        final AnalyticsEvent evt = mgr.createEvent("DeleteNote")
                .withAttribute("noteId", noteHolder.getNote().getNoteId());
        mgr.recordEvent(evt);
        mgr.submitEvents();
    }


The Add Note operation occurs in the ``NoteDetailFragment.java`` class.
Review the :code:`saveData()` method, and add the highlighted
code:

.. code-block:: java
   :emphasize-lines: 24-31

    private void saveData() {
        // Save the edited text back to the item.
        boolean isUpdated = false;
        if (!mItem.getTitle().equals(editTitle.getText().toString().trim())) {
            mItem.setTitle(editTitle.getText().toString().trim());
            mItem.setUpdated(DateTime.now(DateTimeZone.UTC));
            isUpdated = true;
        }
        if (!mItem.getContent().equals(editContent.getText().toString().trim())) {
            mItem.setContent(editContent.getText().toString().trim());
            mItem.setUpdated(DateTime.now(DateTimeZone.UTC));
            isUpdated = true;
        }

        // Convert to ContentValues and store in the database.
        if (isUpdated) {
            ContentValues values = mItem.toContentValues();
            if (isUpdate) {
                contentResolver.update(itemUri, values, null, null);
            } else {
                itemUri = contentResolver.insert(NotesContentContract.Notes.CONTENT_URI, values);
                isUpdate = true;    // Anything from now on is an update

                // Send Custom Event to Amazon Pinpoint
                final AnalyticsClient mgr = AWSProvider.getInstance()
                        .getPinpointManager()
                        .getAnalyticsClient();
                final AnalyticsEvent evt = mgr.createEvent("AddNote")
                        .withAttribute("noteId", mItem.getNoteId());
                mgr.recordEvent(evt);
                mgr.submitEvents();
            }
        }
    }


The AnalyticsClient and AnalyticsEvent classes are not imported by
default. Use Alt-Return to import the missing classes.


  .. list-table::
   :widths: 1 6

   * - **Tip**

     - Auto Import

       You can set up Auto-Import to automatically import
       classes that you need. On Windows or Linux, you can find Auto-Import
       under :guilabel:`File** > Settings`. On a Mac, you can find the same area
       under :guilabel:`iOS Studio > Preferences`. The auto-import setting is
       under :guilabel:`Editor > General > Auto Import >Java`. Change
       :guilabel:`Insert imports on paste` to :guilabel:`All` and select the :guilabel:`Add unambiguous
       imports on the fly` option.

Run the project and validate results
------------------------------------

Re-build the application and run the application within the emulator. It
should work as before. Ensure you try to add and delete some notes to
generate some traffic that can be shown in the Pinpoint console.

To view the demographics and custom events:

1. Open the [Amazon Pinpoint console][pinpoint-console].
2. Select your project. It is based on your Mobile Hub project name.
3. Click :guilabel:`Analytics` in the left hand menu.
4. You should see an up-tick in several graphs:

   .. image:: images/pinpoint-overview.png
      :scale: 100 %
      :alt: Image of the Amazon Pinpoint console.

   .. only:: pdf

      .. image:: images/pinpoint-overview.png
         :scale: 50

   .. only:: kindle

      .. image:: images/pinpoint-overview.png
         :scale: 75


5. Choose :guilabel:`Demographics` to view the demographics information.

   .. image:: images/pinpoint-demographics.png
      :scale: 100 %
      :alt: Image of the Amazon Pinpoint console Demographics tab.

   .. only:: pdf

      .. image:: images/pinpoint-demographics.png
         :scale: 50

   .. only:: kindle

      .. image:: images/pinpoint-demographics.png
         :scale: 75


6. Choose :guilabel:`Events`.
7. Use the Event drop down to show only the :guilabel:AddNote` event.

   .. image:: images/pinpoint-addnote.png
      :scale: 100 %
      :alt: Image of the Add note event in the Amazon Pinpoint.

   .. only:: pdf

      .. image:: images/pinpoint-addnote.png
         :scale: 50

   .. only:: kindle

      .. image:: images/pinpoint-addnote.png
         :scale: 75


If you see data within each page, you have successfully added analytics
to your app. Should you release your app on the App Store, you can come
back here to see more details about your users.

.. include:: git-checkin.rst

Next steps
----------

-  Learn more about `Amazon Pinpoint <https://aws.amazon.com/pinpoint/>`_.
-  Continue by adding :ref:`Authentication <tutorial-ios-aws-mobile-notes-auth>`


Add permissions to the iOSManifest.xml
------------------------------------------

1. Open the project in iOS Studio.
2. Choose :guilabel:`Project` on the left side of the project if you cannot see
   the project browser.
3. Add the :code:`INTERNET`, :code:`ACCESS_NETWORK_STATE`, and
   :code:`ACCESS_WIFI_STATE`: permissions to your project's :file:`iOSManifest.xml` file.

.. code-block:: xml
   :emphasize-lines: 5-7

    <?xml version="1.0" encoding="utf-8"?>
    <manifest xmlns:ios="http://schemas.ios.com/apk/res/ios"
        package="com.amazonaws.mobile.samples.mynotes">

        <uses-permission ios:name="ios.permission.INTERNET"/>
        <uses-permission ios:name="ios.permission.ACCESS_NETWORK_STATE"/>
        <uses-permission ios:name="ios.permission.ACCESS_WIFI_STATE"/>

        <application
            ios:allowBackup="true"
            ios:icon="@mipmap/ic_launcher"
            ios:label="@string/app_name"
            ios:roundIcon="@mipmap/ic_launcher_round"
            ios:supportsRtl="true"
            ios:theme="@style/AppTheme"
            ios:name=".Application">
            <!-- Other settings -->
        </application>
    </manifest>

Add AWS SDK for iOS library to the project
----------------------------------------------

Edit the :file:`app/build.gradle` file. Add the following lines to the
:code:`dependencies` section:

.. code-block:: xml
   :emphasize-lines: 11-14

   dependencies {
      compile fileTree(dir: 'libs', include: ['*.jar'])
      compile 'com.ios.support:appcompat-v7:25.3.1'
      compile 'com.ios.support:support-v4:25.3.1'
      compile 'com.ios.support:cardview-v7:25.3.1'
      compile 'com.ios.support:recyclerview-v7:25.3.1'
      compile 'com.ios.support.constraint:constraint-layout:1.0.2'
      compile 'com.ios.support:design:25.3.1'
      compile 'com.ios.support:multidex:1.0.1'
      compile 'joda-time:joda-time:2.9.9'
      # AWS SDK for iOS
      compile 'com.amazonaws:aws-ios-sdk-core:2.6.+'
      compile 'com.amazonaws:aws-ios-sdk-auth-core:2.6.+@aar'
      compile 'com.amazonaws:aws-ios-sdk-pinpoint:2.6.+'
   }

Download the AWS configuration file
-----------------------------------

First, create a :file:`raw` resource folder to store the AWS configuration file:

1. Expand the :file:`app` folder.
2. Right-click the :file:`res` folder.
3. Choose :guilabel:`New > iOS resource directory`.
4. Choose the :guilabel:`Resource type` dropdown menu and select :guilabel:`raw`.
5. choose :guilabel:`OK`.

Then download the AWS configuration file from AWS Mobile Hub and place
it in the :file:`res/raw` folder:

1. Open the `AWS Mobile Hub console <https://console.aws.amazon.com/mobilehub/home/>`_.
2. Select your project.
3. Choose :guilabel:`Integrate` in the left hand menu bar.
4. Choose :guilabel:`Download Configuration File` in step 1.
5. Copy the :file:`awsconfiguration.json` file to the
   :file:`app/src/main/res/raw` directory.

.. note:: Tip: Use Reveal in Finder

   If you are having trouble locating the
   right directory on disk, use iOS Studio. Right-click the :file:`raw` folder,
   then select :guilabel:`Reveal in Finder`. A new window with the location of the :file:`raw directory` pre-loaded will appear.

Create an AWSProvider.java singleton class
------------------------------------------

In our sample, all access to AWS is consolidated into a singleton class
called :file:`AWSProvider.java`.

1. Expand :file:`app/java` in the iOS Studio project explorer.
2. Right-click the :file:`com.amazonaws.mobile.samples.mynotes` directory.
3. Select :guilabel:`New > Java Class`.
4. Enter the details:

   -  Name: :userinput:`AWSProvider`
   -  Kind: :userinput:`Singleton`

5. Choose :guilabel:`OK`.

You may be asked if you want to add the file to Git. Choose :guilabel:`Yes`.

The following is the initial code in this class:

.. code-block:: java

    package com.amazonaws.mobile.samples.mynotes;

    import ios.content.Context;

    import com.amazonaws.auth.AWSCredentialsProvider;
    import com.amazonaws.mobile.auth.core.IdentityManager;
    import com.amazonaws.mobile.config.AWSConfiguration;
    import com.amazonaws.mobileconnectors.pinpoint.PinpointConfiguration;
    import com.amazonaws.mobileconnectors.pinpoint.PinpointManager;

    public class AWSProvider {
        private static AWSProvider instance = null;
        private Context context;
        private AWSConfiguration awsConfiguration;
        private PinpointManager pinpointManager;

        public static AWSProvider getInstance() {
            return instance;
        }

        public static void initialize(Context context) {
            if (instance == null) {
                instance = new AWSProvider(context);
            }
        }

        private AWSProvider(Context context) {
            this.context = context;
            this.awsConfiguration = new AWSConfiguration(context);

            IdentityManager identityManager = new IdentityManager(context, awsConfiguration);
            IdentityManager.setDefaultIdentityManager(identityManager);
        }

        public Context getContext() {
            return this.context;
        }

        public AWSConfiguration getConfiguration() {
            return this.awsConfiguration;
        }

        public IdentityManager getIdentityManager() {
            return IdentityManager.getDefaultIdentityManager();
        }

        public PinpointManager getPinpointManager() {
            if (pinpointManager == null) {
                final AWSCredentialsProvider cp = getIdentityManager().getCredentialsProvider();
                PinpointConfiguration config = new PinpointConfiguration(
                        getContext(), cp, getConfiguration());
                pinpointManager = new PinpointManager(config);
            }
            return pinpointManager;
        }
    }

    .. note:: What does this do?

       The AWSProvider provides a central place
       to add code that accesses AWS resources. The constructor will load the
       AWS Configuration (a JSON file that we downloaded earlier) and create an
       IdentityManager object that is used to authenticate the device and/or
       user to AWS for accessing resources. The :code:`getPinpointManager()` method
       will create a connection to Amazon Pinpoint if it doesn't exist.

Update the Application class
----------------------------

All iOS applications that include the AWS SDK for iOS must
inherit from
`MultiDexApplication <https://developer.ios.com/studio/build/multidex.html>`_.
This has been done for you in this project. Open the
:file:`Application.java` file. In the :code:`onCreate()` method of the
:code:`Application` class, add code to initialize the :code:``AWSProvider` object
we previously added:

.. code-block:: java
   :emphasize-lines: 6,7

   public class Application extends MultiDexApplication {
      @Override
      public void onCreate() {
          super.onCreate();

          // Initialize the AWS Provider
          AWSProvider.initialize(getApplicationContext());

          registerActivityLifecycleCallbacks(new ActivityLifeCycle());
      }
   }


Update the ActivityLifeCycle class
----------------------------------

We use an
`ActivityLifeCycle <https://developer.ios.com/guide/components/activities/activity-lifecycle.html>`_
to monitor for activity events like start, stop, pause and resume. We
need to determine when the user starts the application so that we can
send a :code:`startSession` event and :code:`stopSession` event to Amazon
Pinpoint. Adjust the :code:`onActivityStarted()` and :code:`onActivityStopped()`
methods as follows:

.. code-block:: java
   :emphasize-lines: 5,6,16,17

    @Override
    public void onActivityStarted(Activity activity) {
        if (depth == 0) {
            Log.d("ActivityLifeCycle", "Application entered foreground");
            AWSProvider.getInstance().getPinpointManager().getSessionClient().startSession();
            AWSProvider.getInstance().getPinpointManager().getAnalyticsClient().submitEvents();
        }
        depth++;
    }

    @Override
    public void onActivityStopped(Activity activity) {
        depth--;
        if (depth == 0) {
            Log.d("ActivityLifeCycle", "Application entered background");
            AWSProvider.getInstance().getPinpointManager().getSessionClient().stopSession();
            AWSProvider.getInstance().getPinpointManager().getAnalyticsClient().submitEvents();
        }
    }


Monitor add and delete notes in Amazon Pinpoint
-----------------------------------------------

We can also monitor feature usage within our app. In this example, we
will monitor how often users add and delete notes. We will record a
custom event for each operation. The Delete Note operation occurs in the
:file:`NoteListActivity.java` class. Review the :code:`onSwiped` method at line
142, and add the following code:

.. code-block:: java
   :emphasize-lines: 6-13

    @Override
    public void onSwiped(RecyclerView.ViewHolder viewHolder, int direction) {
        final NoteViewHolder noteHolder = (NoteViewHolder) viewHolder;
        ((NotesAdapter) notesList.getAdapter()).remove(noteHolder);

        // Send Custom Event to Amazon Pinpoint
        final AnalyticsClient mgr = AWSProvider.getInstance()
                .getPinpointManager()
                .getAnalyticsClient();
        final AnalyticsEvent evt = mgr.createEvent("DeleteNote")
                .withAttribute("noteId", noteHolder.getNote().getNoteId());
        mgr.recordEvent(evt);
        mgr.submitEvents();
    }


The Add Note operation occurs in the ``NoteDetailFragment.java`` class.
Review the :code:`saveData()` method, and add the highlighted
code:

.. code-block:: java
   :emphasize-lines: 24-31

    private void saveData() {
        // Save the edited text back to the item.
        boolean isUpdated = false;
        if (!mItem.getTitle().equals(editTitle.getText().toString().trim())) {
            mItem.setTitle(editTitle.getText().toString().trim());
            mItem.setUpdated(DateTime.now(DateTimeZone.UTC));
            isUpdated = true;
        }
        if (!mItem.getContent().equals(editContent.getText().toString().trim())) {
            mItem.setContent(editContent.getText().toString().trim());
            mItem.setUpdated(DateTime.now(DateTimeZone.UTC));
            isUpdated = true;
        }

        // Convert to ContentValues and store in the database.
        if (isUpdated) {
            ContentValues values = mItem.toContentValues();
            if (isUpdate) {
                contentResolver.update(itemUri, values, null, null);
            } else {
                itemUri = contentResolver.insert(NotesContentContract.Notes.CONTENT_URI, values);
                isUpdate = true;    // Anything from now on is an update

                // Send Custom Event to Amazon Pinpoint
                final AnalyticsClient mgr = AWSProvider.getInstance()
                        .getPinpointManager()
                        .getAnalyticsClient();
                final AnalyticsEvent evt = mgr.createEvent("AddNote")
                        .withAttribute("noteId", mItem.getNoteId());
                mgr.recordEvent(evt);
                mgr.submitEvents();
            }
        }
    }


The AnalyticsClient and AnalyticsEvent classes are not imported by
default. Use Alt-Return to import the missing classes.

  .. note:: Tip: Auto-Import

     You can set up Auto-Import to automatically import
     classes that you need. On Windows or Linux, you can find Auto-Import
     under :guilabel:`File** > Settings`. On a Mac, you can find the same area
     under :guilabel:`iOS Studio > Preferences`. The auto-import setting is
     under :guilabel:`Editor > General > Auto Import >Java`. Change
     ":guilabel:`Insert imports on paste`to :guilabel:`All` and select the `Add unambiguous
     imports on the fly` option.

Run the project and validate results
------------------------------------

Re-build the application and run the application within the emulator. It
should work as before. Ensure you try to add and delete some notes to
generate some traffic that can be shown in the Pinpoint console.

To view the demographics and custom events:

1. Open the [Amazon Pinpoint console][pinpoint-console].
2. Select your project. It is based on your Mobile Hub project name.
3. Click :guilabel:`Analytics` in the left hand menu.
4. You should see an up-tick in several graphs:

   .. image:: images/pinpoint-overview.png
      :scale: 100 %
      :alt: Image of the Amazon Pinpoint console.

   .. only:: pdf

      .. image:: images/pinpoint-overview.png
         :scale: 50

   .. only:: kindle

      .. image:: images/pinpoint-overview.png
         :scale: 75


5. Choose :guilabel:`Demographics` to view the demographics information.

   .. image:: images/pinpoint-demographics.png
      :scale: 100 %
      :alt: Image of the Amazon Pinpoint console Demographics tab.

   .. only:: pdf

      .. image:: images/pinpoint-demographics.png
         :scale: 50

   .. only:: kindle

      .. image:: images/pinpoint-demographics.png
         :scale: 75


6. Choose :guilabel:`Events`.
7. Use the Event drop down to show only the :guilabel:AddNote` event.

   .. image:: images/pinpoint-addnote.png
      :scale: 100 %
      :alt: Image of the Add note event in the Amazon Pinpoint.

   .. only:: pdf

      .. image:: images/pinpoint-addnote.png
         :scale: 50

   .. only:: kindle

      .. image:: images/pinpoint-addnote.png
         :scale: 75


If you see data within each page, you have successfully added analytics
to your app. Should you release your app on the App Store, you can come
back here to see more details about your users.

.. literal-include:: git-checkin.rst

Next steps
----------

-  Learn more about `Amazon Pinpoint <https://aws.amazon.com/pinpoint/>`_.
-  Continue by adding :ref:`Authentication <tutorial-ios-aws-mobile-notes-auth>`

